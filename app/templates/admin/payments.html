{% extends "layout.html" %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-semibold mb-6">Payments</h1>

  <!-- Filter Form -->
  <form method="get" class="flex flex-wrap gap-4 items-end mb-8 p-6 bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
    <div class="flex-grow">
      <label for="q" class="block text-sm text-gray-700 mb-1">Search</label>
      <input type="text" id="q" name="q" value="{{ q or '' }}" placeholder="user/package/promo"
        class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 pl-3">
    </div>

    <div>
      <label for="status" class="block text-sm text-gray-700 mb-1">Status</label>
      <select id="status" name="status" class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 pl-3">
        {% set st = status or 'all' %}
        <option value="all" {{ 'selected' if st=='all' else '' }}>All</option>
        <option value="pending" {{ 'selected' if st=='pending' else '' }}>Pending</option>
        <option value="approved" {{ 'selected' if st=='approved' else '' }}>Approved</option>
        <option value="rejected" {{ 'selected' if st=='rejected' else '' }}>Rejected</option>
      </select>
    </div>

    <div>
      <label for="sort" class="block text-sm text-gray-700 mb-1">Sort</label>
      <select id="sort" name="sort" class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 pl-3">
        {% set s = sort or 'updated_desc' %}
        <option value="updated_desc" {{ 'selected' if s=='updated_desc' else '' }}>Updated (newest)</option>
        <option value="updated_asc" {{ 'selected' if s=='updated_asc' else '' }}>Updated (oldest)</option>
        <option value="id_desc" {{ 'selected' if s=='id_desc' else '' }}>ID High→Low</option>
        <option value="id_asc" {{ 'selected' if s=='id_asc' else '' }}>ID Low→High</option>
        <option value="total_desc" {{ 'selected' if s=='total_desc' else '' }}>Total High→Low</option>
        <option value="total_asc" {{ 'selected' if s=='total_asc' else '' }}>Total Low→High</option>
      </select>
    </div>

    <button type="submit" class="inline-flex items-center rounded-lg px-4 py-2 font-medium btn-secondary bg-gray-800 text-white hover:bg-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-800">Filter</button>
  </form>

  <!-- Payments Table -->
  <div class="overflow-x-auto bg-white rounded-2xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
    <table class="min-w-full text-base divide-y divide-gray-200">
      <thead class="bg-gray-50 text-gray-600">
        <tr>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">ID</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">User</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">Package</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">Promotion</th>
          <th scope="col" class="px-4 py-3 text-right font-medium whitespace-nowrap">Total</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">Updated</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">Status</th>
          <th scope="col" class="px-4 py-3 text-left font-medium whitespace-nowrap">Action</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% if rows %}
        {% for p in rows %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">
            <a href="{{ url_for('admin.payment_detail', pid=p.id) }}"
              class="text-blue-600 hover:underline font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 rounded">#{{ "PAY%05d"|format(p.id) }}</a>
          </td>
          <td class="px-4 py-3 text-sm text-gray-600">{{ p.user and p.user.username or '-' }}</td>
          <td class="px-4 py-3 text-sm text-gray-600">
            {{ p.package and (p.package.name or p.package.code) or '-' }}
          </td>
          <td class="px-4 py-3 text-sm text-gray-600">
            {% if p.promotion %}
              {{ p.promotion.code }} - {{ p.promotion.name }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="px-4 py-3 text-right font-medium text-sm text-gray-600">{{ "{:,.2f}".format(p.total or 0) }} ฿</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ p.updated_at }}</td>
          <td class="px-4 py-3">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
              {% if p.status == 'approved' %}bg-green-100 text-green-800
              {% elif p.status == 'pending' %}bg-yellow-100 text-yellow-800
              {% elif p.status == 'rejected' %}bg-red-100 text-red-800
              {% else %}bg-gray-100 text-gray-800{% endif %}">
              {{ p.status }}
            </span>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <a href="{{ url_for('admin.payment_detail', pid=p.id) }}"
              class="inline-flex items-center rounded-lg px-4 py-2 font-medium btn-primary bg-blue-600 text-white hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 text-sm">
              View details
            </a>
          </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="8" class="px-4 py-12 text-center text-gray-500">
            <div class="flex flex-col items-center">
              <div class="text-gray-400 mb-2">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <p class="text-base text-gray-500 mt-2">No payments found</p>
            </div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
