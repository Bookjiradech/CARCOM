{% extends "layout.html" %}
{% block content %}

<div class="space-y-8">
  <div>
    <h1 class="text-3xl font-semibold text-gray-900 mb-2">My Account</h1>
    <p class="text-sm text-gray-600">Manage account information and security settings</p>
  </div>

  <div class="grid md:grid-cols-3 gap-6">
    <div class="bg-white rounded-2xl shadow-sm border p-6">
      <div class="text-sm text-gray-500 mb-1">Username</div>
      <div class="text-2xl font-semibold text-gray-900 mb-3">{{ current_user.username }}</div>
      <div class="text-sm">
        <span class="text-gray-600">Role:</span>
        {% if current_user.is_admin %}
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">
            Administrator
          </span>
        {% else %}
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 ml-2">
            User
          </span>
        {% endif %}
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border p-6">
      <div class="text-sm text-gray-500 mb-1">Remaining Credits</div>
      <div class="text-3xl font-bold text-blue-600">{{ total_credits or 0 }}</div>
      <div class="text-xs text-gray-500 mt-1">credits</div>
    </div>

    <!-- การ์ดเวลาแพ็กเกจ: เปลี่ยนเป็นเคาน์ต์ดาวน์ -->
    <div class="bg-white rounded-2xl shadow-sm border p-6">
      <div class="text-sm text-gray-500 mb-1">Package Time Remaining</div>
      {% if remaining_seconds is not none %}
        <div class="text-3xl font-bold text-green-600">
          <span id="pkg-countdown"
                data-remaining-seconds="{{ remaining_seconds|int }}">--</span>
        </div>
        <div class="text-xs text-gray-500 mt-1">days : hours : minutes : seconds</div>
      {% else %}
        <div class="text-3xl font-bold text-green-600">∞</div>
        <div class="text-xs text-gray-500 mt-1">Unlimited</div>
      {% endif %}
    </div>
  </div>

  <div class="space-y-6">
    <!-- Reset Password -->
    <details class="bg-white rounded-2xl shadow-sm border overflow-hidden">
      <summary class="cursor-pointer px-6 py-4 font-medium text-gray-900 hover:bg-gray-50 transition-colors focus:outline-none focus:bg-gray-50">
        <span class="flex items-center justify-between">
          Reset Password
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </span>
      </summary>
      <div class="border-t border-gray-100 p-6">
        <form method="post" action="{{ url_for('auth.account_reset_password') }}" class="space-y-4">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
              <input type="password" name="old_password"
                     class="h-10 w-full rounded-lg  border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
              <input type="password" name="new_password"
                     class="h-10 w-full rounded-lg  border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" minlength="8" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
              <input type="password" name="confirm"
                     class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" minlength="8" required>
            </div>
          </div>
          <div class="pt-2">
            <button class="inline-flex items-center rounded-lg px-4 py-2 font-medium bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 transition-colors">
              Save
            </button>
          </div>
        </form>
      </div>
    </details>

    <!-- Reset Security Questions -->
    <details class="bg-white rounded-2xl shadow-sm border overflow-hidden">
      <summary class="cursor-pointer px-6 py-4 font-medium text-gray-900 hover:bg-gray-50 transition-colors focus:outline-none focus:bg-gray-50">
        <span class="flex items-center justify-between">
          Reset Security Questions
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </span>
      </summary>
      <div class=" border border-t border-gray-100 p-6">
        <form method="post" action="{{ url_for('auth.account_reset_security') }}" class="space-y-6">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% set qlist = [
            "What is the name of your first pet?",
            "What is the name of your elementary school?",
            "In which city were you born?",
            "What is your favorite food?",
            "What was your childhood nickname?"
          ] %}

          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Security Question 1</label>
                <select name="question1"
                        class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" required>
                  <option value="">-- Select a question --</option>
                  {% for q in qlist %}
                    <option value="{{ q }}">{{ q }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Answer 1</label>
                <input name="answer1"
                       class="h-10 w-full rounded-lg  border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" required>
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Security Question 2</label>
                <select name="question2"
                        class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" required>
                  <option value="">-- Select a question --</option>
                  {% for q in qlist %}
                    <option value="{{ q }}">{{ q }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Answer 2</label>
                <input name="answer2"
                       class="h-10 w-full rounded-lg border border-gray-300 focus:border-blue-600 focus:ring-2 focus:ring-blue-600 focus:ring-opacity-20 transition-colors" required>
              </div>
            </div>
          </div>

          <div class="pt-2">
            <button class="inline-flex items-center rounded-lg px-4 py-2 font-medium bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 transition-colors">
              Save
            </button>
          </div>
        </form>
      </div>
    </details>
  </div>

  <div class="bg-white rounded-2xl shadow-sm border">
    <div class="px-6 py-4 border  border-b border-gray-100">
      <h2 class="text-xl font-semibold text-gray-900">Payment History</h2>
    </div>

    {% if payments and payments|length > 0 %}
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
              <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
              <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for p in payments %}
              {% set st = (p.status or '').lower() %}
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ "PAY%05d"|format(p.id) }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ p.method or '-' }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right">
                  {{ "{:,.2f}".format(p.total or 0) }} ฿
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                      {% if st=='paid' %} bg-green-100 text-green-800
                      {% elif st=='pending' %} bg-yellow-100 text-yellow-800
                      {% elif st=='rejected' %} bg-red-100 text-red-800
                      {% else %} bg-gray-100 text-gray-800 {% endif %}">
                    {{ p.status or '-' }}
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="px-6 py-8 text-center">
        <div class="text-gray-400 mb-2">
          <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </div>
        <p class="text-gray-600">No payment history yet</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- สคริปต์เคาน์ต์ดาวน์ -->
<script>
(function () {
  const el = document.getElementById('pkg-countdown');
  if (!el) return;

  let seconds = parseInt(el.dataset.remainingSeconds || "0", 10);
  if (isNaN(seconds) || seconds < 0) seconds = 0;

  function fmt(n) { return n.toString().padStart(2, '0'); }

  function render(sec) {
    const days = Math.floor(sec / 86400);
    sec %= 86400;
    const hours = Math.floor(sec / 3600);
    sec %= 3600;
    const mins = Math.floor(sec / 60);
    const secs = sec % 60;
    el.textContent = `${days}d ${fmt(hours)}h ${fmt(mins)}m ${fmt(secs)}s`;
  }

  render(seconds);

  const timer = setInterval(() => {
    if (seconds <= 0) {
      render(0);
      clearInterval(timer);
      return;
    }
    seconds -= 1;
    render(seconds);
  }, 1000);
})();
</script>

{% endblock %}
